/*** 
 * @Author: baisichen
 * @Date: 2022-10-18 20:53:45
 * @LastEditTime: 2022-10-19 16:34:46
 * @LastEditors: baisichen
 * @Description: 测试修改TCP缓冲区-server端
 */
#include <sys/socket.h> //socket头文件
#include <netinet/in.h> //最新的socket地址sorckaddr_in
#include <arpa/inet.h>  //包含了各种地址转换函数的头文件，如htons，inet_hton
#include <unistd.h>     //包含了各种系统调用头文件
#include <stdio.h>
#include <stdlib.h> //通用工具函数，srand(), exit(), atoi这种
#include <errno.h>  //定义了通过错误码来回报错误资讯的宏
#include <string.h>
#include <libgen.h> //定义了basename和dirname，用于处理特殊字符或路径
#include <assert.h> //断言
#define BUFFER_SIZE 1024
using namespace std;

int main(int argc, char *argv[])
{
    if (argc < 2)
    {
        printf("usage : %s ip_address port_number recv_buffer_size\n", basename(argv[0]));
        return 1;
    }
    const char *ip = argv[1];
    int port = atoi(argv[2]);

    struct sockaddr_in address;
    bzero(&address, sizeof(address));
    address.sin_family = AF_INET;
    inet_pton(AF_INET, ip, &address.sin_addr);
    address.sin_port = htons(port);

    int sock = socket(PF_INET, SOCK_STREAM, 0);
    assert(sock >= 0);
    //监听之前设置各种选项
    int recvbuf(atoi(argv[3]));
    int len = sizeof(recvbuf);
    //设置TCP缓冲区大小，然后立即获取一下
    setsockopt(sock, SOL_SOCKET, SO_RCVBUF, &recvbuf, sizeof(recvbuf));
    getsockopt(sock, SOL_SOCKET, SO_RCVBUF, &recvbuf, (socklen_t *)&len);
    /*
        linux系统设置默认256，这个机器默认改成了2304字节
        ./server 10.81.114.214 9030 50
        the tcp recv buffer size after setting is 2304
    */
    printf("the tcp recv buffer size after setting is %d\n", recvbuf);

    int ret = bind(sock, (struct sockaddr *)&address, sizeof(address));
    assert(ret != -1);

    ret = listen(sock, 5);
    assert(ret != -1);

    struct sockaddr_in client;
    socklen_t client_addrlength = sizeof(client);
    int connfd = accept(sock, (struct sockaddr *)&client, &client_addrlength);
    if (connfd < 0)
    {
        printf("errno is: %d\n", errno);
    }
    else
    {
        char buffer[BUFFER_SIZE];
        memset(buffer, '\0', BUFFER_SIZE);
        while (recv(connfd, buffer, BUFFER_SIZE - 1, 0) > 0)
        {
            
        }
        printf("recv buffer:%s", buffer);
        close(connfd);
    }
    close(sock);
    return 0;
}

/*
服务器启动时最小窗口为2304：the tcp recv buffer size after setting is 2304
客户端启动时，最小窗口为4608：the tcp send buffer size after setting is 4608
#1-3个包为三次握手，第二个包反馈给客户端win(TCP窗口为1152字节)
IP 10.81.112.77.53597 > 10.81.114.214.9030: Flags [S], seq 3611766786, win 29200, options [mss 1460,sackOK,TS val 3157677225 ecr 0,nop,wscale 8], length 0
	0x0000:  4500 003c 64ab 4000 3d06 e14b 0a51 704d
	0x0010:  0a51 72d6 d15d 2346 d747 3002 0000 0000
	0x0020:  a002 7210 d15b 0000 0204 05b4 0402 080a
	0x0030:  bc36 54a9 0000 0000 0103 0308
IP 10.81.114.214.9030 > 10.81.112.77.53597: Flags [S.], seq 359241826, ack 3611766787, win 1152, options [mss 1460,sackOK,TS val 3157654378 ecr 3157677225,nop,wscale 0], length 0
	0x0000:  4500 003c 0000 4000 4006 42f7 0a51 72d6
	0x0010:  0a51 704d 2346 d15d 1569 9862 d747 3003
	0x0020:  a012 0480 f7f3 0000 0204 05b4 0402 080a
	0x0030:  bc35 fb6a bc36 54a9 0103 0300
IP 10.81.112.77.53597 > 10.81.114.214.9030: Flags [.], ack 1, win 115, options [nop,nop,TS val 3157677225 ecr 3157654378], length 0
	0x0000:  4500 0034 64ac 4000 3d06 e152 0a51 704d
	0x0010:  0a51 72d6 d15d 2346 d747 3003 1569 9863
	0x0020:  8010 0073 0c49 0000 0101 080a bc36 54a9
	0x0030:  bc35 fb6a
#客户端发送一个长度为576的第一个包，编号左开右闭[1,577)
IP 10.81.112.77.53597 > 10.81.114.214.9030: Flags [.], seq 1:577, ack 1, win 115, options [nop,nop,TS val 3157677225 ecr 3157654378], length 576
	0x0000:  4500 0274 64ad 4000 3d06 df11 0a51 704d
	0x0010:  0a51 72d6 d15d 2346 d747 3003 1569 9863
	0x0020:  8010 0073 7c7b 0000 0101 080a bc36 54a9
	0x0030:  bc35 fb6a 6161 6161 6161 6161 6161 6161
	0x0040:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0050:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0060:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0070:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0080:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0090:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00a0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00b0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00c0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00d0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00e0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00f0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0100:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0110:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0120:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0130:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0140:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0150:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0160:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0170:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0180:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0190:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01a0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01b0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01c0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01d0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01e0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01f0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0200:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0210:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0220:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0230:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0240:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0250:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0260:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0270:  6161 6161
IP 10.81.114.214.9030 > 10.81.112.77.53597: Flags [.], ack 577, win 1152, options [nop,nop,TS val 3157654378 ecr 3157677225], length 0
	0x0000:  4500 0034 6309 4000 4006 dff5 0a51 72d6
	0x0010:  0a51 704d 2346 d15d 1569 9863 d747 3243
	0x0020:  8010 0480 f7eb 0000 0101 080a bc35 fb6a
	0x0030:  bc36 54a9
#客户端发送一个长度为576的第二个包，seq来到了1153，编号为557到1153
IP 10.81.112.77.53597 > 10.81.114.214.9030: Flags [P.], seq 577:1153, ack 1, win 115, options [nop,nop,TS val 3157677225 ecr 3157654378], length 576
	0x0000:  4500 0274 64ae 4000 3d06 df10 0a51 704d
	0x0010:  0a51 72d6 d15d 2346 d747 3243 1569 9863
	0x0020:  8018 0073 7a33 0000 0101 080a bc36 54a9
	0x0030:  bc35 fb6a 6161 6161 6161 6161 6161 6161
	0x0040:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0050:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0060:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0070:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0080:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0090:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00a0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00b0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00c0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00d0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00e0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00f0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0100:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0110:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0120:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0130:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0140:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0150:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0160:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0170:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0180:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0190:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01a0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01b0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01c0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01d0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01e0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01f0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0200:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0210:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0220:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0230:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0240:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0250:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0260:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0270:  6161 6161
#客户端发送一个长度为576的第三个包，seq来到了1729，编号为1153到1729
IP 10.81.112.77.53597 > 10.81.114.214.9030: Flags [.], seq 1153:1729, ack 1, win 115, options [nop,nop,TS val 3157677225 ecr 3157654378], length 576
	0x0000:  4500 0274 64af 4000 3d06 df0f 0a51 704d
	0x0010:  0a51 72d6 d15d 2346 d747 3483 1569 9863
	0x0020:  8010 0073 77fb 0000 0101 080a bc36 54a9
	0x0030:  bc35 fb6a 6161 6161 6161 6161 6161 6161
	0x0040:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0050:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0060:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0070:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0080:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0090:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00a0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00b0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00c0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00d0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00e0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00f0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0100:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0110:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0120:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0130:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0140:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0150:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0160:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0170:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0180:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0190:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01a0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01b0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01c0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01d0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01e0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01f0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0200:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0210:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0220:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0230:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0240:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0250:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0260:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0270:  6161 6161
IP 10.81.114.214.9030 > 10.81.112.77.53597: Flags [.], ack 1153, win 1152, options [nop,nop,TS val 3157654379 ecr 3157677225], length 0
	0x0000:  4500 0034 630a 4000 4006 dff4 0a51 72d6
	0x0010:  0a51 704d 2346 d15d 1569 9863 d747 3483
	0x0020:  8010 0480 f7eb 0000 0101 080a bc35 fb6b
	0x0030:  bc36 54a9
#到这次ack之前win都是0，每ack一次，窗口释放出576
IP 10.81.114.214.9030 > 10.81.112.77.53597: Flags [.], ack 1729, win 576, options [nop,nop,TS val 3157654379 ecr 3157677225], length 0
	0x0000:  4500 0034 630b 4000 4006 dff3 0a51 72d6
	0x0010:  0a51 704d 2346 d15d 1569 9863 d747 36c3
	0x0020:  8010 0240 f7eb 0000 0101 080a bc35 fb6b
	0x0030:  bc36 54a9
IP 10.81.114.214.9030 > 10.81.112.77.53597: Flags [.], ack 1729, win 1152, options [nop,nop,TS val 3157654379 ecr 3157677225], length 0
	0x0000:  4500 0034 630c 4000 4006 dff2 0a51 72d6
	0x0010:  0a51 704d 2346 d15d 1569 9863 d747 36c3
	0x0020:  8010 0480 f7eb 0000 0101 080a bc35 fb6b
	0x0030:  bc36 54a9
#客户端发送一个长度为576的第4个包，seq来到了2305，编号为1729到2305
IP 10.81.112.77.53597 > 10.81.114.214.9030: Flags [P.], seq 1729:2305, ack 1, win 115, options [nop,nop,TS val 3157677226 ecr 3157654379], length 576
	0x0000:  4500 0274 64b0 4000 3d06 df0e 0a51 704d
	0x0010:  0a51 72d6 d15d 2346 d747 36c3 1569 9863
	0x0020:  8018 0073 75b1 0000 0101 080a bc36 54aa
	0x0030:  bc35 fb6b 6161 6161 6161 6161 6161 6161
	0x0040:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0050:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0060:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0070:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0080:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0090:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00a0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00b0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00c0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00d0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00e0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x00f0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0100:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0110:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0120:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0130:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0140:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0150:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0160:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0170:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0180:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0190:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01a0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01b0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01c0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01d0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01e0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x01f0:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0200:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0210:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0220:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0230:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0240:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0250:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0260:  6161 6161 6161 6161 6161 6161 6161 6161
	0x0270:  6161 6161
#客户端发送一个长度为1的第5个包，seq来到了2306，最大编号为2306-1=2305，至此这里发送完了整个2305字节的数据
IP 10.81.112.77.53597 > 10.81.114.214.9030: Flags [P.], seq 2305:2306, ack 1, win 115, options [nop,nop,TS val 3157677226 ecr 3157654379], length 1
	0x0000:  4500 0035 64b1 4000 3d06 e14c 0a51 704d
	0x0010:  0a51 72d6 d15d 2346 d747 3903 1569 9863
	0x0020:  8018 0073 a23d 0000 0101 080a bc36 54aa
	0x0030:  bc35 fb6b 61
#客户端发送FIN，表示发完了，可以断开链接，客户端进入FIN_WAIT_1
IP 10.81.112.77.53597 > 10.81.114.214.9030: Flags [F.], seq 2306, ack 1, win 115, options [nop,nop,TS val 3157677226 ecr 3157654379], length 0
	0x0000:  4500 0034 64b2 4000 3d06 e14c 0a51 704d
	0x0010:  0a51 72d6 d15d 2346 d747 3904 1569 9863
	0x0020:  8011 0073 0345 0000 0101 080a bc36 54aa
	0x0030:  bc35 fb6b
IP 10.81.114.214.9030 > 10.81.112.77.53597: Flags [.], ack 2305, win 576, options [nop,nop,TS val 3157654379 ecr 3157677226], length 0
	0x0000:  4500 0034 630d 4000 4006 dff1 0a51 72d6
	0x0010:  0a51 704d 2346 d15d 1569 9863 d747 3903
	0x0020:  8010 0240 f7eb 0000 0101 080a bc35 fb6b
	0x0030:  bc36 54aa
IP 10.81.114.214.9030 > 10.81.112.77.53597: Flags [.], ack 2306, win 575, options [nop,nop,TS val 3157654379 ecr 3157677226], length 0
	0x0000:  4500 0034 630e 4000 4006 dff0 0a51 72d6
	0x0010:  0a51 704d 2346 d15d 1569 9863 d747 3904
	0x0020:  8010 023f f7eb 0000 0101 080a bc35 fb6b
	0x0030:  bc36 54aa
#服务器确认FIN包，进入CLOSE_WAIT状态；同时客户端收到FIN的ACK后进入FIN_WAIT_2状态
IP 10.81.114.214.9030 > 10.81.112.77.53597: Flags [.], ack 2307, win 574, options [nop,nop,TS val 3157654379 ecr 3157677226], length 0
	0x0000:  4500 0034 630f 4000 4006 dfef 0a51 72d6
	0x0010:  0a51 704d 2346 d15d 1569 9863 d747 3905
	0x0020:  8010 023e f7eb 0000 0101 080a bc35 fb6b
	0x0030:  bc36 54aa
#服务器发送FIN包，进入LAST_ACK阶段
IP 10.81.114.214.9030 > 10.81.112.77.53597: Flags [F.], seq 1, ack 2307, win 1152, options [nop,nop,TS val 3157654379 ecr 3157677226], length 0
	0x0000:  4500 0034 6310 4000 4006 dfee 0a51 72d6
	0x0010:  0a51 704d 2346 d15d 1569 9863 d747 3905
	0x0020:  8011 0480 f7eb 0000 0101 080a bc35 fb6b
	0x0030:  bc36 54aa
#客户端收到FIN包，发送ACK，并进入到TIME_WAIT阶段，等待2MSL后可以释放socket占用的端口；服务器收到ACK后关闭TCP链接
IP 10.81.112.77.53597 > 10.81.114.214.9030: Flags [.], ack 2, win 115, options [nop,nop,TS val 3157677226 ecr 3157654379], length 0
	0x0000:  4500 0034 8420 4000 3d06 c1de 0a51 704d
	0x0010:  0a51 72d6 d15d 2346 d747 3905 1569 9864
	0x0020:  8010 0073 0344 0000 0101 080a bc36 54aa
	0x0030:  bc35 fb6b
*/